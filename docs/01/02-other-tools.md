# 1.2 Javaにおけるパフォーマンス分析と障害診断

Oracle JDKを含むOpenJDKディストリビューション(以下、JavaまたはJDK)にはJFR以外にも様々な分析用の方法/ツールがあります。

本章ではJavaにおける基本的なメトリクス取得のアプローチを紹介していきます。

## パフォーマンス分析の基本

Javaにはパフォーマンスメトリクスを取得するための方法がいくつかあります。代表的なのは下記の3つでしょう。

- JMX
- ログ
- JPLIS(javaagent)

### JMX

Java Management Extensions(JMX)はJavaのリソース監視および管理のためのプロトコルです。簡単にいえばJava版のSNMPです。
JSR-174としてJava 1.5より取り込まれています。

Managed Bean(MBean)を利用してCPUやメモリの情報を取得したり、特定のイベント(例えば強制GC)とかを実行することも可能です。

MBeanを自前で定義する事もでき、元々JavaEEから始まった技術という事もあってWeblogicやGlassFishと言った多くのアプリケーションコンテナがスレッド数や待機リクエスト数など様々なメトリクスをJMXで取得できるようにしています。そのため、Java製のアプリケーションを監視するときの最も基本的な選択肢となります。

ただし、近年では独自プロトコルは監視ツール側との連携がしづらいと言う点からJMXをHTTPベースに変換するOSSのJolokiaや、JMXに代わる新しいメトリクス取得インターフェースであるEclipse Microprofile Metricsなどが登場しています。

### ログ

JavaではGCなどの詳細なログをJVMより取得することができます。元々、Javaはバージョンアップと共に様々なシステムログが取れるように進化してきたのですが、一貫性がなくそれぞれのログフォーマットや設定方法を覚える必要がありました。

しかし、Java 9よりUnified JVM Loggingとしてシステムログに関する仕様が統合されています。結果として、利便性は上がったのですがJava 8の頃とオプション等が違うので古いドキュメントを見たりする時は注意してください。

例えばGCログなら以下のようにJVMオプションに指定することでログファイルに出力されます。

```bash
-Xlog:gc*=debug:/path/to/gc_%p_%t.log:time,level,tags:filesize=100m,filecount=7
```

また、スレッドダンプをログファイルに定期的に出したいと言うニーズもあるかと思いますが、これはJVMのログ機能ではできません。そのため、後述する`jstack`や`jcmd`、あるいは`kill -3`を定期的に実行してファイルに書き込むコマンドを作るのが一般的でした。

ただ、JFRを使うならJFR側にスタックトレースが含まれているのでそちらで十分でしょう。

### JPLIS(javaagent)

Java Programming Language Instrumentation Services(JPLIS)は`java.lang.instrument`と言う、あまり聞き慣れないパッケージに連携するためのインターフェースです。`javaagent`をJMVオプションとして指定する事で利用します。

これはJVMがクラスをロードするタイミングでエージェントがクラスの情報を書き換えるAPIとなります。これを使ってJavaのオブジェクト情報を取得したり、プロファイリング用のアスペクトを埋め込んでトレース情報を取得するなどの使い方があります。

資料が少ないのが難点ですがAspectJなどと組み合わせると比較的簡単に利用できます。

原理上ほぼどんな値でも取れるので、多くのAPMはこのJavaエージェントを使用して実装されています。ただしバイトコードを書き換える特性上、広範囲に原因特定のし難いバグを発生させるリスクがあるので、テスト/デバックは入念に行って利用しましょう。

## JDK標準ツール

デフォルトで含まれるツールも多くあります。

### JConsole

JMXをプロファイリングツールです。かなり昔からあるので古い書籍やWebサイトでも性能試験に利用するツールとして紹介されていたりします。

JMXはJava版SNMPと言った仕様でCPU, ヒープ, GC, ロードクラス数等の情報が取得できます。シンプルなUIの良いツールですが最近はVisualVMやJMCで同様の事が出来るので役目を終えた感があります。

### Java VisualVM

Java Mission ControlがJDKに統合されるまでHotSpotの主力だったプロファイリングツールです。OSS版は下記で開発されています。

https://visualvm.github.io/index.html


NetBeans Platformをベースにしているためプラグイン構造を持っているのが特徴の一つです。

JConsoleと同様にJMXの情報のモニタリングが出来ることに加えて、ヒープダンプを出力したり解析情報のスナップショットをとったりとかなり高機能なツールでした。

JMCがHotSpotにも同梱されるようになって以来少し影が薄くなりましたが、GraalVMにも対応しており最新版ではプレビュー版ながらJFRにも対応したようなので今後再注目されるかもしれません。

### JDK Mission Control(JMC)

現状のJavaでは主流のプロファイリングツールです。OSS版は下記で開発されています。

https://github.com/JDKMissionControl/jmc

元々、JRockit Mission Controlと呼ばれJRockitで定評のあったプロファイリングツールをOracleのSunの買収をきっかけにHotSpot側に取り込んだツールとなります。

同じくJRockit由来のJFRと密接に連携。。と言うかJFRのビジュアライズツールとしてはほぼ一択の状態です。

機能としてはVisualVMと同様に統合分析ツールとなっておりリアルタイムのJMX監視やヒープダンプおよびJFRの取得/分析が可能です。

VisualVMとは対照的にEclipseのGUIフレームワークをベースにしており同じく柔軟なプラグイン機能を備えます。Weblogicなど製品に特化したプラグインが存在しているのも特徴の一つです。

HotSpotへの移植およびOSS化に伴って「JRockit Mission Control」 -> 「Java Mission Control」 -> 「JDK Mission Control」と名前が変わっていますが略称はJMCのままです。

また、オープン化されたJMC 7よりUIが大きく変わっており、自動分析の機能も強化されています。

ただし、執筆時点の2019/10/06時点でまだ正式版がリリースされておらず公式からバイナリがダウンロードでき無いため自分でビルドする必要があると言う状態が続いています。

当面はOpenJDKディストリビュータがビルドしている「Zulu Mission Control」や「Liberica Mission Control」を使うのが便利だと思われます。

### jcmd

jcmdはJFRと同様に元々はJRockitで使われていたコマンドです。そのため既存のコマンドと機能が重複していますが、統合されていて便利なのでjcmdで基本操作を済ませる事が多い気がします。

代表的なコマンドとしては`JFRの操作`, `jpsのようなプロセスの取得`, `jstackのようにスレッドダンプの取得`などがあります。

### hprof

古くからあるJava標準のプロファイリングツールです。CPU使用率、ヒープ情報、ヒープダンプなどを取得/分析できます。

ただし、かなりオーバーヘッドが大きく本番に適用できるタイプのものではありません。また開発やテスト時も現在ならIDEに付属したプロファイラの方が使い勝手は良いと思われます。

### jps

JVMのプロセスIDを表示するコマンドです。Linuxの場合、psコマンドでももちろん特定できますがJava以外のプロセスが表示されないのでフィルタに便利です。

### jstat

GCを含むヒープの情報をみるコマンドです。Javaのメモリ構造は様々な階層があり複雑ですがそれをモニタリングする事ができます。

個人的には監視ツール経由でJMXかJFRで見る事が多いのであまり使うことは無いかと思います。

### jstack

JVMのスレッドダンプを取得するコマンドです。

デッドロックなどスレッドロックを分析するときに良く使用します。単独で使うと言うよりは取得したスレッドダンプを「侍」「ThreadLogic」「TDA」あたりに渡して使います。

スレッドダンプは障害時の重要な情報になるので定期実行をするスクリプトを組むか、障害時に数回叩いてスレッドの情報を取得します。

### jmap

jmapはヒープダンプを取得するためのツールです。

プロセス情報やヒープ情報、クラスローダの情報を取得できヒープサマリー、ヒストグラム、統計情報と様々な情報が取得できます。

出力結果はjhatやサードパーティーツールで分析するのが一般的です。ただし、jmapはフルGCを引き起こす可能性があるため本番での利用は注意して行う必要があります。
